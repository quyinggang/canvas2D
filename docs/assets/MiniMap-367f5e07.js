import{g as f,E as $}from"./index-894cb8bb.js";import{_ as B,r as E,o as L,a as D,b as V,c as P,d as W}from"./index-b7bb8ac5.js";const Z={__name:"MiniMap",setup(F){const v=E(null),w=E(null);return L(()=>{const y=v.value,M=w.value,p={mapBackground:"#161c22",textColor:"#fff",maxZoom:10,minZoom:.1};class x{constructor(t=[1,0,0,1,0,0]){this.matrix=[...t]}invert(){const t=this.matrix,e=1/(t[0]*t[3]-t[1]*t[2]),n=t[3]*e,s=-t[1]*e,o=-t[2]*e,r=t[0]*e,i=e*(t[2]*t[5]-t[3]*t[4]),a=e*(t[1]*t[4]-t[0]*t[5]);return new x([n,s,o,r,i,a])}multiply(t){const e=this.matrix;var n=e[0]*t[0]+e[2]*t[1],s=e[1]*t[0]+e[3]*t[1],o=e[0]*t[2]+e[2]*t[3],r=e[1]*t[2]+e[3]*t[3],i=e[0]*t[4]+e[2]*t[5]+e[4],a=e[1]*t[4]+e[3]*t[5]+e[5];e[0]=n,e[1]=s,e[2]=o,e[3]=r,e[4]=i,e[5]=a}changeScaler(t){const e=this.matrix;e[0]=t,e[3]=t}changeTranslation({x:t,y:e}){const n=this.matrix;n[4]=t,n[5]=e}getScaler(){return this.matrix[0]}getTranslation(){const t=this.matrix;return{x:t[4],y:t[5]}}clone(){return[...this.matrix]}point(t){const e=this.matrix;return{x:e[0]*t.x+e[2]*t.y+e[4],y:e[1]*t.x+e[3]*t.y+e[5]}}}class C extends ${constructor(t){super(),this.element=t.element,this.offset=t.offset,this.scale=t.scale||1,this.zoomVisible=!0,this.scaleStep=1.04,this.transform=new x,this.handleMoveDown=this.onMoveDown.bind(this),this.handleWheel=this.onWheel.bind(this),this.bindEvents()}bindEvents(){const t=this.element;t.addEventListener("mousedown",this.handleMoveDown),t.addEventListener("wheel",this.handleWheel,{passive:!1})}panTo({x:t,y:e}){this.transform.changeTranslation({x:t,y:e})}zoomTo(t){this.transform.changeScaler(t)}moveBy({x:t,y:e}){const n=this.transform,s=n.getTranslation(),o={x:s.x+t,y:s.y+e};n.changeTranslation(o)}onWheel(t){if(!this.zoomVisible)return;t.stopPropagation(),t.preventDefault();const{transform:e,offset:n,scaleStep:s}=this,{pageX:o,pageY:r,deltaY:i}=t,a=o-n.left,l=r-n.top,h=e.getScaler(),m=e.getTranslation(),c=i>0?h*s:h/s;if(c>p.maxZoom||c<p.minZoom)return;const d={x:(a-m.x)/h,y:(l-m.y)/h},z={x:-d.x*c+a,y:-d.y*c+l};this.panTo(z),this.zoomTo(c),this.emit("onZoom")}onMoveDown(t){t.stopPropagation();let e=!0;const n=this.scale,{left:s,top:o}=this.offset,r=this.transform;let i={x:(t.pageX-s)/n,y:(t.pageY-o)/n};const a=h=>{if(!e)return;const m={x:(h.pageX-s)/n,y:(h.pageY-o)/n},c=r.getTranslation(),d={x:m.x-i.x,y:m.y-i.y};this.panTo({x:d.x+c.x,y:d.y+c.y}),this.emit("onMove",{...d}),this.emit("onPan"),i=m},l=()=>{e=!1,window.removeEventListener("mousemove",a),window.removeEventListener("mouseup",l)};window.addEventListener("mousemove",a),window.addEventListener("mouseup",l)}setZoomVisible(t){this.zoomVisible=!!t}destroy(){const t=this.element;t.removeEventListener("wheel",this.handleWheel),t.removeEventListener("mousedown",this.handleMoveDown),this.element=null}}class b{constructor(t){this.domElement=document.createElement("canvas"),this.ctx=this.domElement.getContext("2d"),this.setCanvasSize(t),this.setCanvasAttrs(),this.ctx.scale(t.pixel,t.pixel)}setCanvasSize(t){const{width:e,height:n,pixel:s}=t;this.width=e*s,this.height=n*s,this.styleWidth=e,this.styleHeight=n}setCanvasAttrs(){const{width:t,height:e,styleWidth:n,styleHeight:s,domElement:o}=this;o.width=t,o.height=e,o.style.cssText=`width:${n}px;height:${s}px;`}}class g{constructor(t){this.x=t.x,this.y=t.y,this.radius=t.radius,this.color=t.color,this.text=t.text}render(t){const{x:e,y:n,radius:s,color:o,text:r}=this,i=t.measureText(r);t.save(),t.fillStyle=o,t.beginPath(),t.arc(e,n,s,0,2*Math.PI,!1),t.fill(),t.fillStyle=p.textColor,t.beginPath(),t.fillText(r,e-i.width*.5,n+4),t.restore()}}class _{constructor(t){this.container=t.container,this.createMapLayer(),this.createScene(),this.createMouseController()}createMapLayer(){const e=this.container.getBoundingClientRect(),{width:n,height:s}=e;this.canvas=new b({width:n,height:s,pixel:window.devicePixelRatio}),this.clientCenter={x:n*.5,y:s*.5},this.boundingClient=e}createScene(){const t=this.clientCenter;this.shapes=[new g({x:t.x*.5,y:t.y*.5,color:f(),radius:20,text:"左上"}),new g({x:t.x,y:t.y,color:f(),radius:40,text:"中心"}),new g({x:t.x*1.5,y:t.y*1.5,color:f(),radius:20,text:"右下"})]}createMouseController(){const{boundingClient:t,canvas:e}=this,n=new C({element:e.domElement,offset:{top:t.top,left:t.left}});this.mouseController=n}getTransform(){return this.mouseController.transform}resetScene(){this.mouseController.setVisible(!0),this.mouseController.transform=new x(this.originMatrix)}renderMap(){const{canvas:t,mouseController:e,shapes:n}=this,{ctx:s,width:o,height:r}=t,i=e.transform.matrix;s.clearRect(0,0,o,r),s.save(),s.fillStyle=p.mapBackground,s.fillRect(0,0,o,r),s.transform(i[0],i[1],i[2],i[3],i[4],i[5]);for(const a of n)a.render(s);s.restore()}mountCanvas(){this.container.appendChild(this.canvas.domElement)}destroy(){this.container=null,this.mouseController.destroy()}}class S{constructor(t){this.container=t.container,this.boundingClient=this.container.getBoundingClientRect(),this.mapManager=t.mapManager,this.isRendered=!1,this.createThumb(),this.createViewerLayer(),this.zoomSceneToThumb(),this.calcDragBoxRect(),this.createMouseController(),this.bindEvents()}createThumb(){const t=document.createElement("div"),e=document.createElement("div");t.appendChild(e),this.container.appendChild(t),this.dragElement=e,this.thumbElement=t}createViewerLayer(){const{width:t,height:e}=this.mapManager.canvas;this.canvas=new b({width:t,height:e,pixel:1})}createMouseController(){const{zoomToFit:t,dragElement:e}=this,n=new C({element:e,offset:{top:0,left:0},scale:t*9.6});n.setZoomVisible(!1),this.mouseController=n}zoomSceneToThumb(){const{width:t,height:e}=this.boundingClient,{width:n,height:s}=this.mapManager.canvas,o=Math.min(t/n,e/s),r={x:(t-n*o)*.5,y:(e-s*o)*.5},i=`position:absolute;top:0;left:0;width:${n}px;height:${s}px;z-index:1;`,a=`transform-origin:0 0;transform:translate(${r.x}px,${r.y}px) scale(${o});`;this.thumbElement.style.cssText=`${i}${a}`,this.zoomToFit=o}calcDragBoxRect(){const{mapManager:t,zoomToFit:e}=this,{width:n,height:s}=t.boundingClient,o=window.devicePixelRatio,r=t.getTransform().invert(),i=r.point({x:0,y:0}),a=r.point({x:n,y:s}),l={x:i.x*o,y:i.y*o,width:(a.x-i.x)*o,height:(a.y-i.y)*o},h="position:absolute;top:0px;left:0px;z-index:2;box-sizing:border-box;",m=`width:${l.width}px;height:${l.height}px;`,c=`transform-origin:top left;transform:translate(${l.x}px,${l.y}px);`,d=`border: ${Math.round(1/e)}px solid #fff;`;this.dragElement.style.cssText=`${h}${m}${c}${d}`}renderViewer(){if(this.isRendered)return;const{canvas:t,mapManager:e}=this,n=t.ctx;n.clearRect(0,0,t.width,t.height),n.save(),n.drawImage(e.canvas.domElement,0,0),n.restore(),this.isRendered=!0}bindEvents(){const{mapManager:t,mouseController:e}=this,n=t.mouseController;n.on("onPan",()=>{this.calcDragBoxRect()}),n.on("onZoom",()=>{this.calcDragBoxRect()}),e.on("onMove",s=>{const o=t.getTransform().getScaler(),r={x:-s.x*o,y:-s.y*o};n.moveBy(r),this.calcDragBoxRect()})}mountCanvas(){this.thumbElement.appendChild(this.canvas.domElement)}destroy(){this.container=null}}class R{constructor(t){this.raf=null,this.createManager(t),this.mount()}createManager(t){const{container:e,viewer:n}=t,s=new _({container:e});this.viewManager=new S({container:n,mapManager:s}),this.mapManager=s}renderFrame(){this.mapManager.renderMap(),this.viewManager.renderViewer()}renderLoop(){this.renderFrame(),this.raf=window.requestAnimationFrame(this.renderLoop.bind(this))}mount(){this.mapManager.mountCanvas(),this.viewManager.mountCanvas()}destroy(){this.mapManager.destroy(),this.viewManager.destroy()}}const T=new R({container:y,viewer:M});T.renderLoop(),D(()=>T.destroy())}),(y,M)=>(V(),P("div",{class:"box",ref_key:"boxElementRef",ref:v},[W("div",{class:"viewer",ref_key:"viewElementRef",ref:w},null,512)],512))}},H=B(Z,[["__scopeId","data-v-66b155f4"]]);export{H as default};
