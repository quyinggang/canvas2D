import{l as z,a as T,g as B}from"./index-894cb8bb.js";import{_ as A,r as W,o as Z,a as V,b as Y,c as F,p as H,e as N,d as w}from"./index-b7bb8ac5.js";const U=""+new URL("robot-1b034a4d.png",import.meta.url).href;const X=f=>(H("data-v-4a19cd4d"),f=f(),N(),f),O=X(()=>w("ul",{class:"btn-container"},[w("li",{id:"follow",class:"btn"},"跟随"),w("li",{id:"locate",class:"btn"},"定位"),w("li",{id:"reset",class:"btn"},"重置")],-1)),$=[O],q={__name:"SceneMap",setup(f){const b=W(null);return Z(()=>{const M=b.value,m={mapBackground:"#161c22",textColor:"#fff",maxZoom:10,minZoom:.1,shapeCount:100,sceneOffset:60,robotId:-1};class g{constructor(t=[1,0,0,1,0,0]){this.matrix=[...t]}invert(){const t=this.matrix,e=1/(t[0]*t[3]-t[1]*t[2]),o=t[3]*e,s=-t[1]*e,a=-t[2]*e,i=t[0]*e,n=e*(t[2]*t[5]-t[3]*t[4]),r=e*(t[1]*t[4]-t[0]*t[5]);return new g([o,s,a,i,n,r])}multiply(t){const e=this.matrix;var o=e[0]*t[0]+e[2]*t[1],s=e[1]*t[0]+e[3]*t[1],a=e[0]*t[2]+e[2]*t[3],i=e[1]*t[2]+e[3]*t[3],n=e[0]*t[4]+e[2]*t[5]+e[4],r=e[1]*t[4]+e[3]*t[5]+e[5];e[0]=o,e[1]=s,e[2]=a,e[3]=i,e[4]=n,e[5]=r}changeScaler(t){const e=this.matrix;e[0]=t,e[3]=t}changeTranslation({x:t,y:e}){const o=this.matrix;o[4]=t,o[5]=e}getScaler(){return this.matrix[0]}getTranslation(){const t=this.matrix;return{x:t[4],y:t[5]}}clone(){return[...this.matrix]}point(t){const e=this.matrix;return{x:e[0]*t.x+e[2]*t.y+e[4],y:e[1]*t.x+e[3]*t.y+e[5]}}}class E{constructor(t){this.element=t.element,this.offset=t.offset,this.visible=!0,this.scaleStep=1.04,this.transform=new g,this.handleMoveDown=this.onMoveDown.bind(this),this.handleWheel=this.onWheel.bind(this),this.bindEvents()}bindEvents(){const t=this.element;t.addEventListener("mousedown",this.handleMoveDown),t.addEventListener("wheel",this.handleWheel,{passive:!1})}panTo({x:t,y:e}){this.transform.changeTranslation({x:t,y:e})}zoomTo(t){this.transform.changeScaler(t)}onWheel(t){if(!this.visible)return;t.stopPropagation(),t.preventDefault();const{transform:e,offset:o,scaleStep:s}=this,{pageX:a,pageY:i,deltaY:n}=t,r=a-o.left,l=i-o.top,h=e.getScaler(),d=e.getTranslation(),c=n>0?h*s:h/s;if(c>m.maxZoom||c<m.minZoom)return;const u={x:(r-d.x)/h,y:(l-d.y)/h},x={x:-u.x*c+r,y:-u.y*c+l};this.panTo(x),this.zoomTo(c)}onMoveDown(t){if(!this.visible)return;t.stopPropagation();let e=!0;const{left:o,top:s}=this.offset,a=this.transform;let i={x:t.pageX-o,y:t.pageY-s};const n=l=>{if(!e)return;const h={x:l.pageX-o,y:l.pageY-s},d=a.getTranslation();this.panTo({x:h.x-i.x+d.x,y:h.y-i.y+d.y}),i=h},r=()=>{e=!1,window.removeEventListener("mousemove",n),window.removeEventListener("mouseup",r)};window.addEventListener("mousemove",n),window.addEventListener("mouseup",r)}setVisible(t){this.visible=!!t}destroy(){const t=this.element;t.removeEventListener("wheel",this.handleWheel),t.removeEventListener("mousedown",this.handleMoveDown),this.element=null}}class _{constructor(t){this.domElement=document.createElement("canvas"),this.ctx=this.domElement.getContext("2d"),this.setCanvasSize(t),this.setCanvasAttrs(),this.ctx.scale(t.pixel,t.pixel)}setCanvasSize(t){const{width:e,height:o,pixel:s}=t;this.width=e*s,this.height=o*s,this.styleWidth=e,this.styleHeight=o}setCanvasAttrs(){const{width:t,height:e,styleWidth:o,styleHeight:s,domElement:a}=this;a.width=t,a.height=e,a.style.cssText=`width:${o}px;height:${s}px;`}}class I{constructor(t){this.x=t.x,this.y=t.y,this.radius=t.radius,this.color=t.color,this.text=t.text}render(t){const{x:e,y:o,radius:s,color:a,text:i}=this,n=t.measureText(i);t.save(),t.fillStyle=a,t.beginPath(),t.arc(e,o,s,0,2*Math.PI,!1),t.fill(),t.fillStyle=m.textColor,t.beginPath(),t.fillText(i,e-n.width*.5,o+4),t.restore()}}class P{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.image=t.image,this.angle=t.angle,this.originPosition={x:t.x,y:t.y}}moveTo({x:t,y:e}){this.x=t,this.y=e}render(t){const{x:e,y:o,width:s,height:a,image:i,angle:n}=this;t.save(),t.rotate(n),t.drawImage(i,e-s*.5,o-a*.5,s,a),t.restore()}reset(){const t=this.originPosition;this.x=t.x,this.y=t.y}}class R{constructor(t){this.container=t.container,this.following=!1,this.createMapLayer(),this.createMouseController(),this.createScene(),this.changeToCenter(),this.computeDisplayAllScaler()}createMapLayer(){const e=this.container.getBoundingClientRect(),{width:o,height:s}=e;this.canvas=new _({width:o,height:s,pixel:window.devicePixelRatio}),this.clientCenter={x:o*.5,y:s*.5},this.boundingClient=e}createMouseController(){const{boundingClient:t,canvas:e}=this,o=new E({element:e.domElement,offset:{top:t.top,left:t.left}});this.mouseController=o}createScene(){const t=[],e={sx:-1e3,sy:-1e3,ex:1e3,ey:1e3},o=m.shapeCount;for(let n=0;n<o;n++){const r={x:T(e.sx,e.ex),y:T(e.sy,e.ey),color:B(),radius:10,text:n};n===o-1&&(r.x=0,r.y=0,r.radius=20),t.push(new I(r))}const s={x:0,y:0};this.shapes=t,this.sceneRange=e;const a={x:e.ex,y:e.ey},i=[];for(let n=0;n<=1;n+=.001)i.push({x:(1-n)*s.x+n*a.x,y:(1-n)*s.y+n*a.y});this.robotDirection=1,this.robotPathIndex=0,this.robotPath=i}createRobot(t){this.robot=new P({x:0,y:0,width:200,height:200,image:t,angle:0}),this.shapes.push(this.robot)}getTransform(){return this.mouseController.transform}changeToCenter(){this.mouseController.panTo(this.clientCenter)}computeDisplayAllScaler(){const{boundingClient:t,sceneRange:e,mouseController:o}=this,s=o.transform,a=s.getScaler(),i=s.getTranslation(),n=m.sceneOffset,{sx:r,sy:l,ex:h,ey:d}=e,c=h-r,u=d-l;let x=Math.min((t.width-n)/c,(t.height-n)/u);x=Math.max(Math.min(x,m.maxZoom),m.minZoom);const{x:y,y:C}=s.point({x:0,y:0}),S={x:(y-i.x)/a,y:(C-i.y)/a},k={x:-S.x*x+y,y:-S.y*x+C};o.panTo(k),o.zoomTo(x),this.originMatrix=o.transform.clone()}startMove(){if(!this.following)return;const{robot:t,robotPath:e,robotPathIndex:o,robotDirection:s}=this,a=e.length-1;let i=0,n=s;if(s>=0){const r=o+1;i=Math.min(r,a),n=i>=a?-1:1}else{const r=o-1;i=Math.max(r,0),n=i<=0?1:-1}t.moveTo(e[i]),this.robotDirection=n,this.robotPathIndex=i,this.transformShapeToCenter({x:t.x,y:t.y,width:t.width,height:t.height})}followShape(){this.mouseController.setVisible(!1),this.following=!this.following}transformShapeToCenter(t){const{x:e,y:o,width:s,height:a}=t,{mouseController:i,boundingClient:n,originMatrix:r}=this,l=new g(r),h=l.getScaler(),d=l.getTranslation();let c=Math.min(n.width*.5/s,n.height*.5/a);c=Math.max(Math.min(c,m.maxZoom),m.minZoom);const u=l.point({x:e,y:o}),x={x:(u.x-d.x)/h,y:(u.y-d.y)/h},y={x:-x.x*c+d.x,y:-x.y*c+d.y};i.panTo(y),i.zoomTo(c)}locateShape(){const t=this.shapes,e=Math.floor(Math.random()*m.shapeCount),o=t[e||0],s=o.radius*2;this.transformShapeToCenter({x:o.x,y:o.y,width:s,height:s}),this.following=!1,this.mouseController.setVisible(!0)}resetScene(){this.following=!1,this.robot.reset(),this.mouseController.setVisible(!0),this.mouseController.transform=new g(this.originMatrix)}mountCanvas(){this.container.appendChild(this.canvas.domElement)}destroy(){this.container=null,this.mouseController.destroy()}}class L{constructor(t){this.tools=t,this.bindEvents()}bindEvents(){const t=this.tools;Array.isArray(t)&&t.forEach(e=>{const{element:o,callback:s}=e;o.addEventListener("click",s)})}destroy(){const t=this.tools;Array.isArray(t)&&t.forEach(e=>{const{element:o,callback:s}=e;o.removeEventListener("click",s)}),this.tools=null}}class D{constructor(t){this.raf=null,this.createManager(t),this.mount()}createManager(t){const{container:e}=t,o=new R({container:e});this.toolManager=new L([{element:document.getElementById("follow"),callback:()=>o.followShape()},{element:document.getElementById("locate"),callback:()=>o.locateShape()},{element:document.getElementById("reset"),callback:()=>o.resetScene()}]),this.mapManager=o}createRobot(t){this.mapManager.createRobot(t)}renderFrame(){const t=this.mapManager,{canvas:e,mouseController:o,shapes:s}=t,{ctx:a,width:i,height:n}=e,r=o.transform.matrix;a.clearRect(0,0,i,n),a.save(),a.fillStyle=m.mapBackground,a.fillRect(0,0,i,n),t.startMove(),a.transform(r[0],r[1],r[2],r[3],r[4],r[5]);for(const l of s)l.render(a);a.restore()}renderLoop(){this.renderFrame(),this.raf=window.requestAnimationFrame(this.renderLoop.bind(this))}mount(){this.mapManager.mountCanvas()}destroy(){this.mapManager.destroy(),this.toolManager.destroy()}}const v=new D({container:M});z(U).then(p=>{v.createRobot(p),v.renderLoop()}),V(()=>v.destroy())}),(M,m)=>(Y(),F("div",{class:"box",ref_key:"boxElementRef",ref:b},$,512))}},J=A(q,[["__scopeId","data-v-4a19cd4d"]]);export{J as default};
